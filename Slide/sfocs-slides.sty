\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{sfocs-slides}[2021/04/03 SilverFOCS theme for lslides]

\def\logo{SF-head}

% colors 
\RequirePackage{xcolor}

\definecolor{global}{HTML}{5BC346}
\definecolor{tech}{HTML}{FAAA33}
\definecolor{com}{HTML}{B665CD}
\definecolor{game}{HTML}{3397C1}

% package options 
\RequirePackage{xkeyval}

% xkeyval already loaded by lslides
\define@boolkey{sfocs-slides.sty}[sfocsslides@]{global}[true]{}
\define@boolkey{sfocs-slides.sty}[sfocsslides@]{tech}[true]{}
\define@boolkey{sfocs-slides.sty}[sfocsslides@]{com}[true]{}
\define@boolkey{sfocs-slides.sty}[sfocsslides@]{game}[true]{}

% default to global
\ExecuteOptionsX{global}
\ProcessOptionsX

\ifsfocsslides@global
	\colorlet{topic}{global}\def\topic{global}
\fi

\ifsfocsslides@tech
	\colorlet{topic}{tech}\def\topic{tech}
\fi

\ifsfocsslides@com
	\colorlet{topic}{com}\def\topic{com}
\fi

\ifsfocsslides@game
	\colorlet{topic}{game}\def\topic{game}
\fi

% fonts 

\RequirePackage{ifxetex,ifluatex}
\newif\ifxetexorluatex
\ifxetex
  \xetexorluatextrue
\else
  \ifluatex
    \xetexorluatextrue
  \else
    \xetexorluatexfalse
  \fi
\fi

\RequirePackage[USenglish]{babel}

% sans math
\RequirePackage{cmbright}
\RequirePackage[cm]{sfmath}

\usefonttheme{professionalfonts}


\ifxetexorluatex 
	
	\RequirePackage{fontspec}
	\setmainfont{CMU Sans Serif}
	\setsansfont{CMU Sans Serif}
	\setmonofont[Scale=.9]{CMU Typewriter Text}

	\ifxetex
		\RequirePackage{xeCJK}
		\setCJKsansfont{AR PL UKai TW MBE:style=Book}
	\else
		\RequirePackage{luatexja-fontspec}
		\setsansjfont{AR PL UKai TW MBE:style=Book}
	\fi
\fi


% colortheme based on topic package option
\definecolorset{rgb}{}{color}{slidebg,.35,.35,.35;slidefg,.9,.9,.9;titlebg,.35,.35,.35}
\definecolorset{rgb}{mind}{color}{chap,.4,.4,.9;sec,1,.2,.2;cursec,.4,.7,.4}
\colorlet{secbgcolor}{topic}
\colorlet{secfgcolor}{slidebgcolor}
\colorlet{chapfgcolor}{secfgcolor}
\colorlet{chapbgcolor}{secbgcolor}
\colorlet{keybgcolor}{topic!75!black}
\colorlet{keyfgcolor}{slidefgcolor}
\colorlet{tocbgcolor}{secbgcolor}
\colorlet{tocfgcolor}{secfgcolor}
\colorlet{titlefgcolor}{slidefgcolor}
\colorlet{structbgcolor}{secbgcolor}
\colorlet{structfgcolor}{slidebgcolor}
\colorlet{ucolor}{secbgcolor!50}

\RequirePackage{tikz}
\usetikzlibrary{shapes,calc,shadings,shadows,positioning,fit,spy}

% beamer setup 
\setbeamertemplate{navigation symbols}{}
\useinnertheme{circles}
\setbeamersize{text margin left=.5cm}
\setbeamersize{text margin right=.5cm}

\setbeamercolor*{item projected}{bg=structbgcolor!75!bg,fg=slidebgcolor}
\setbeamercolor{itemize item}{fg=structbgcolor!75!bg}
\setbeamercolor{itemize subitem}{fg=structbgcolor!75!bg}
\setbeamercolor{itemize subsubitem}{fg=structbgcolor!75!bg}

% easily change slide colors 
\newcommand{\setslidecolor}[2][]{
	\ifx#1\empty\relax
	\else
		\setbeamercolor*{palette tertiary}{#1}
		\setbeamertemplate{frametitle}[ftitle]
	\fi 
	\setbeamercolor*{palette primary}{#2}
	\usebeamercolor*{palette primary}
	\setbeamertemplate{background canvas}[default]
}

% reset to default colors
\newcommand{\resetslidecolor}{
	% wrong banner colors in printable version
%	\mode<handout>{\colorlet{structbgcolor}{yellow}}
	\setbeamercolor*{palette tertiary}{fg=structfgcolor,bg=structbgcolor}
	\setbeamercolor*{palette primary}{fg=slidefgcolor,bg=slidebgcolor}
	\usebeamercolor[fg]{palette primary}
	\setbeamertemplate{background canvas}[default]
% reset bg layer, eg. pic was added
	\setbeamertemplate{background}{}
}

% compute img height based on width, option scale param
\newcommand*{\picheight}[3][1]{
	\newdimen\imageheight
	\settoheight{\imageheight}{%
		\includegraphics[width=#3,keepaspectratio]{#2}%
	}
	\pgfmathsetmacro{\imgh}{#1*1pt/1cm*\imageheight}
}

%
% beamer templates
%

% title page
\defbeamertemplate*{title page}{sfocs-titlepage}{
	\begin{tikzpicture}[remember picture,overlay]
		\hypersetup{urlcolor=topic}
		\clip (current page.north west) rectangle (current page.south east);
		\fill[slidebgcolor!80] (current page.north west) -- ($(current page.west)+(0,.1)$) --
			($(current page.west)+(2,.7)$) -- ($(current page.west)+(3,.15)$) -- ($(current
			page.east)+(-3,.15)$) -- ($(current page.east)+(-2,.7)$) -- ($(current
			page.east)+(0,.1)$) -- (current page.north east) -- cycle;

		\node at ($(current page.center)+(0,-.75)$)	{\includegraphics[scale=.96]{joystick}};
		\node[structbgcolor,font=\Large\bf] at ($(current page.center)+(0,-.85)$) {\href{http://focs.ji.sjtu.edu.cn/silverfocs}{S-FOCS (\topic)}};
		\node[black!70,font=\fontsize{38}{46}\bf,align=center] at	($(current page.north)+(0,-1.85)$) {SilverFOCS\\Incubator};
		\node[structbgcolor!50,font=\fontsize{20}{24}\em,align=center, text width=.95\paperwidth] at ($(current	page.center)+(0,-2.675)$) {\inserttitle};

		\node[anchor=east,topic,font=\scriptsize] at ($(current page.south east)+(0,.25)$) {\insertauthor};
		\node[anchor=west,topic,font=\scriptsize] at ($(current page.south west)+(0,.25)$) {\insertdate};
	\end{tikzpicture}
}

% template for last frame
\setbeamertemplate{sfocs-tksframe}{
		\tikz[remember picture,overlay] \node[text=structbgcolor,anchor=east] at ($(current page.south east)+(-.25,.5)$) {Thank you!};
}

% section pages
\usepackage{totcount}

\regtotcounter{section}
\newcounter{totsec}
\newcounter{tsec}

\newcommand*{\splitsections}[1][\inserttitle]{
	\setcounter{totsec}{\totvalue{section}}
	\setcounter{tsec}{\thetotsec}
	\stepcounter{tsec}
	\ifnum\thetotsec>0
		\begin{tikzpicture}[remember picture,overlay]
			\fill[secfgcolor] (current page.north west) rectangle ($(current page.south	east)+(0,3)$);
			\node[secfgcolor,inner sep=0pt,font=\Large,align=center,text width=5cm] at ($(current page.south west)+(2.6,1.5)$) {#1};
			\draw[ultra thin] ($(current page.south west)+(5.2,2.65)$) -- ($(current page.south west)+(5.2,.35)$);
			\pgfmathsetmacro{\secspace}{3.5/\thetsec}
			\foreach \i in {1,...,\thetotsec}{
				\ifnum \i=\thesection
					\node[text=secfgcolor!5,inner sep=0pt,anchor=west,align=left,text width=7.2cm] at ($(current page.south west)+(5.4,3.25-\i*\secspace)$) {\hyperlink{sec:\thepart:\i}{\ztitleref{sec:\thepart:\i}}};
				\else
					\node[text=secfgcolor,inner sep=0pt,anchor=west,align=left,text width=7.2cm] at ($(current page.south west)+(5.4,3.25-\i*\secspace)$) {\hyperlink{sec:\thepart:\i}{\ztitleref{sec:\thepart:\i}}};
				\fi
			}
			\node[font=\fontsize{50}{55}\selectfont,text=secbgcolor!80!black!60,align=center,text	width=.95\paperwidth] at ($(current page.center)+(0,1.5)$) {\ztitleref{sec:\thepart:\thesection}};
		\end{tikzpicture}
	\fi
}

\defbeamertemplate*{section page}{sfocs-sectionpage}{
	\splitsections 
}


%
% special slides
%

% displayed at the start of asection
\AtBeginSection[]  {
	\setbeamercolor*{palette primary}{fg=secfgcolor,bg=secbgcolor}
	\setbeamercolor*{palette tertiary}{fg=secfgcolor,bg=secbgcolor}
	\usebeamercolor[fg]{palette primary}
	\setbeamertemplate{background canvas}[plain-section][secbgcolor]

	\begin{frame}[label={sec:\thepart:\thesection}]{}
			\sectionpage
	\end{frame}

	\setbeamercolor*{palette primary}{fg=slidefgcolor,bg=slidebgcolor}
	\setbeamercolor*{palette tertiary}{fg=structfgcolor,bg=structbgcolor}
	\usebeamercolor[fg]{palette primary}
	\setbeamertemplate{background canvas}[plain-slide][slidebgcolor]
}

% black bck, free full content
\newenvironment{framem}[2][]{
  \setbeamertemplate{background canvas}[plain-slide]
  \setbeamercolor*{palette primary}{fg=white!80!black,bg=black}
  \usebeamercolor[fg]{palette primary}
% \setbeamercolor*{palette tertiary}{fg=white!75!black,bg=black}
  \hypersetup{urlcolor=.}
  \begin{frame}[t,fragile,environment=framem,#1]{#2}
    \begin{columns}[b]\begin{column}{\paperwidth}
}{
  \end{column}\end{columns}\end{frame}
}

% summary slide with key points
\newenvironment{framek}[1][Highlights]{
	\setbeamertemplate{footline}[empty]
	\setbeamercolor*{palette primary}{fg=keyfgcolor,bg=keybgcolor}
	\setbeamertemplate{background canvas}[default]
	\begin{frame}[environment=framek]{#1}
}{
	\end{frame}
}

% last frame (thanks)
\newcommand*{\thankframe}{
	\setbeamertemplate{footline}[empty]
	\setbeamercolor*{palette primary}{fg=titlefgcolor,bg=titlebgcolor}
	\usebeamercolor[fg]{palette primary}
	\setbeamertemplate{background canvas}[plain-slide]
	\frame{\usebeamertemplate{sfocs-tksframe}}
}



%
% frametitle
%

% shutter shape -- 1: fringes, 2: total section -- cicrle
\tikzset{
		pics/ftitlehorizshading/.style args={#1/#2}{code={
     \pgfdeclarehorizontalshading{horizshading}{#2} {color(0cm)=(#1!90!black); color(\the\paperwidth)=(#1)}
     \node[anchor=north west,inner sep=0,outer sep=0] at (current page.north west) {\pgfuseshading{horizshading}};
    }
   },
	pics/logo/.style args={#1/#2}{code={
			\pgfmathsetmacro{\imghh}{-.5*\imgh}
			\pgfmathsetmacro{\sdone}{\imgh*(\insertframenumber/\inserttotalframenumber)+\imghh}
			\ifxetex
				\node at (.1625,0) {\includegraphics[width=.6cm]{\logo_x}};
			\else
				\node[opacity=.4] at (.1625,0) {\includegraphics[width=.6cm]{\logo}};
			\fi
			\begin{scope}
				\clip (-.3,\imghh) rectangle (.5,\sdone);
				\node (logo) at (.1625,0) {\includegraphics[width=.6cm]{\logo}};
			\end{scope}
		}
	},
}

\defbeamertemplate*{frametitle}{ftitle}[1][1]{
% compute logo size	
	\picheight{\logo}{.6cm}
	\nointerlineskip
	\begin{beamercolorbox}[wd=\paperwidth,ht=.65cm]{frametitle}
  \begin{tikzpicture}[remember picture,overlay]
		\path (current page.north west) pic {ftitlehorizshading=bg/.65cm};
    \path ($(current page.north west)+(.325,-.325)$) pic {logo=3/1};
    \node[anchor=east,align=right,font=\large\vphantom{Ag},inner sep=0pt] at ($(current page.north east)+(-.325,-.325)$) {\insertframetitle\par};
  \end{tikzpicture}
\end{beamercolorbox}
}


\defbeamertemplate*{background canvas}{plain-slide}[1][bg] {
	\begin{pgfpicture}{0cm}{0cm}{\paperwidth}{\paperheight}
		\color{#1}
		\pgfpathrectangle{\pgfpointorigin}{\pgfpoint{\paperwidth}{\paperheight}}
		\pgfusepath{fill}
	\end{pgfpicture}
}

\defbeamertemplatealias{background canvas}{plain-section}{plain-slide}
\defbeamertemplatealias{background canvas}{plain-toc}{plain-slide}
\defbeamertemplatealias{background canvas}{plain-keypoints}{plain-slide}

%  beamer palettes setup 
\setbeamercolor*{palette primary}{fg=slidefgcolor,bg=slidebgcolor}
\setbeamercolor*{normal text}{parent=palette primary}
\setbeamercolor*{itemize/enumerate body}{parent=palette primary}
\setbeamercolor*{background canvas}{parent=palette primary}

\setbeamercolor*{palette secondary}{use=palette primary,fg=palette primary.bg!60!palette primary.fg}
\setbeamercolor*{local structure}{parent=palette secondary}

\setbeamercolor*{palette tertiary}{fg=structfgcolor,bg=structbgcolor}
\setbeamercolor*{structure}{parent=palette tertiary}
\setbeamercolor*{alerted text}{parent=palette tertiary,fg=structbgcolor}

%
% basic aesthetics fixes (mainly spacing)
%

% beamer item with wider space
\RequirePackage{xpatch}

\xpatchcmd{\itemize}{\def\makelabel}{
	\ifnum\@itemdepth=1\relax
		\setlength\itemsep{.25cm}% separation for first level
		\setlength\topsep{.125cm}% separation for first level
	\else
		\ifnum\@itemdepth=2\relax
			\setlength\itemsep{.125cm}% separation for second level
			\setlength\topsep{.125cm}% separation for first level
		\else
			\ifnum\@itemdepth=3\relax
				\setlength\itemsep{0.5ex}% separation for third level
			\fi
		\fi
	\fi
	\def\makelabel
}{}{}

% justify items
\xpatchcmd{\itemize}{\raggedright}{\justifying}{}{}
\xpatchcmd{\beamer@enum@}{\raggedright}{\justifying}{}{}

% enumerate based on list + without \newcommand (beamer/beamerbaselocalstructure.sty)
\def\@llisti{\leftmargin\leftmargini
	\topsep 3\p@ \@plus2\p@ \@minus2.5\p@
	\parsep 0\p@
	\itemsep.25cm \@plus2\p@ \@minus3\p@
}
\def\@llistii{\leftmargin\leftmarginii
	\topsep 3\p@ \@plus2\p@ \@minus2.5\p@
	\parsep 0\p@
	\itemsep.125cm \@plus1\p@ \@minus2\p@
}
\let\@listI\@llisti 
\let\@listii\@llistii 

\newcommand{\hugeskip}{\vspace{.5cm}}
\newcommand*{\nosep}{\itemsep 1pt\vspace{-.125cm}}
\newcommand*{\smallsep}{\itemsep .125cm}
\newcommand*{\medsep}{\itemsep .25cm\smallskip}
\newcommand*{\bigsep}{\itemsep .5cm\medskip}
\newlength{\halfwidth}
\setlength{\halfwidth}{.52275\textwidth}

% hyperref
\hypersetup{colorlinks=true, linkcolor=., urlcolor=ucolor}

% misc packages
\RequirePackage{graphicx}
\graphicspath{{img/}}

\RequirePackage{booktabs,multirow}
\RequirePackage{ragged2e}

%justify text in frame
\apptocmd{\frame}{}{\justifying}{}

\RequirePackage{multicol} % useful to easily split itemize env
\setlength\multicolsep{.125cm}


% references including chapter number / reference to frame number for the handout
\RequirePackage{zref-titleref}
%\zref@newprop{chapterval}{\thepart}
%\zref@localaddprops{main}{chapterval}
%\zref@newprop{frameval}{\theframenumber}
%\zref@localaddprops{main}{frameval}

%\newcommand*{\cref}[1]{\hyperlink{#1}{$\zref[chapterval]{#1}.\zref{#1}$}}

% swicth to zref as default label/ref method
\AtBeginDocument{
	\let\label=\zref@label
}

% atendocument frames (thanks + sources) not counted + not seen by pgfpages 
\newcommand*{\fixenddocument}{%
	\immediate\write\@auxout{%
		\string\@writefile{nav}{\noexpand\headcommand{\noexpand\beamer@documentpages{\the\c@framenumber}}}
		\string\@writefile{nav}{\noexpand\headcommand{\noexpand\gdef\noexpand\inserttotalframenumber{\the\c@framenumber}}}
	}
}


%\newcommand{\sources}{
%	\IfFileExists{\jobname.ent}{
%		\urlstyle{refslide}
%		\setbeamertemplate{frametitle}[ftitle][0]
%		\setbeamercolor*{palette primary}{fg=slidefgcolor,bg=slidebgcolor}
%		\setbeamercolor*{palette tertiary}{fg=structfgcolor,bg=structbgcolor}
%		\usebeamercolor[fg]{palette primary}
%		\setbeamertemplate{background canvas}[plain-slide]
%		\setbeamertemplate{footline}[empty]
%		\begin{frame}[t,allowframebreaks]{References}
%			\setlength{\parskip}{2pt}\footnotesize
%			\theendnotes
%		\end{frame}
%	}
%	{}
%}
%
% automatically add thank frame
\AtEndDocument{%
	\thankframe%
%	\appendices%
%	\sources%
	\fixenddocument%
}


% sources
%\RequirePackage{endnotes}
%\RequirePackage{hanging}
%\def\makeenmark{\cref{source-\theenmark}}
%\def\enoteformat{\makebox[1.5em][r]{\makeenmark}\hspace{1em}}
%\def\enotesize{\footnotesize}
%\def\enoteheading{}

%\newcommand{\source}[1]{
%	\only<1>{
%		\zref@label{source-\theframenumber}
%		\hypertarget{source-\theframenumber}{}
%		\endnotetext[\theframenumber]{\footnotesize\sloppy \hangpara{2.5em}{1}#1}
%	}
%}

\newcommand{\important}[1]{
	\begin{columns}\column{\paperwidth}
	\tikz \node[rectangle,fill=structbgcolor,minimum width=\paperwidth,minimum height=1cm,align=center,text width=.9\paperwidth,font=\Large] {#1};
\end{columns}
}


% used to automatically calculate the size of pics
\usepackage{calc}

\newlength{\heighti}
\newlength{\heightii}
\newlength{\heightiii}
\setlength{\heighti}{\paperheight-.65cm} %total height minus banner height 
\setlength{\heightii}{.5\heighti}
\setlength{\heightiii}{.3333333\heighti}

\newlength{\widthi}
\newlength{\widthii}
\newlength{\widthiii}
\setlength{\widthi}{\paperwidth} %total width minus banner width 
\setlength{\widthii}{.5\widthi}
\setlength{\widthiii}{.3333333\widthi}

\newcommand{\settrans}[1][100]{\gdef\transparent@value{#1}}
\newcommand{\fadedpic}[3][]{% 
	\only<1>{\settrans}\only<2->{\settrans[30]}%
	\begin{tikzpicture}[remember picture, overlay] 
			\coordinate (O) at (current page.center);
			\node[inner sep=0pt, outer sep=0pt,opacity=\transparent@value/100] (fadedpic) at ($(current page.center -| .5\columnwidth,0)-(0,.5\baselineskip+.075cm)$)   {\includegraphics[#1]{#2}};
		\node[below= .15cm of fadedpic, align=center, text width=\columnwidth,opacity=\transparent@value/100] {#3};
	\end{tikzpicture}
}

\endinput
